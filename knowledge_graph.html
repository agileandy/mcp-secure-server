<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Server - Knowledge Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #1a1a2e;
            color: #eee;
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 380px;
            background: #16213e;
            padding: 24px;
            overflow-y: auto;
            border-right: 1px solid #0f3460;
        }
        
        .main {
            flex: 1;
            padding: 24px;
            overflow: auto;
            display: flex;
            flex-direction: column;
        }
        
        h1 {
            color: #e94560;
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        
        h2 {
            color: #0f4c75;
            font-size: 1.1rem;
            margin: 24px 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #0f3460;
        }
        
        h3 {
            color: #3282b8;
            font-size: 0.95rem;
            margin: 16px 0 8px 0;
        }
        
        .subtitle {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 24px;
        }
        
        .section {
            margin-bottom: 20px;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 6px;
            margin-bottom: 6px;
        }
        
        .badge-success { background: #1b4332; color: #40916c; }
        .badge-warning { background: #7c4a03; color: #f4a261; }
        .badge-error { background: #5c1a1a; color: #e76f51; }
        .badge-info { background: #1d3557; color: #a8dadc; }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #0f3460;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #e94560;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            margin-top: 4px;
        }
        
        .finding {
            background: #0f3460;
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 3px solid #e94560;
        }
        
        .finding-title {
            font-weight: 600;
            color: #bbe1fa;
            margin-bottom: 6px;
        }
        
        .finding-desc {
            font-size: 0.85rem;
            color: #aaa;
            line-height: 1.5;
        }
        
        .finding-action {
            font-size: 0.8rem;
            color: #40916c;
            margin-top: 8px;
            font-style: italic;
        }
        
        .file-list {
            list-style: none;
            font-size: 0.85rem;
        }
        
        .file-list li {
            padding: 6px 0;
            border-bottom: 1px solid #0f3460;
            display: flex;
            align-items: center;
        }
        
        .file-list li:last-child {
            border-bottom: none;
        }
        
        .file-icon {
            margin-right: 8px;
            opacity: 0.6;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            padding: 12px;
            background: #0f3460;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.75rem;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            margin-right: 6px;
        }
        
        .graph-container {
            flex: 1;
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            overflow: auto;
        }
        
        .mermaid {
            display: flex;
            justify-content: center;
        }
        
        code {
            background: #0f3460;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #f4a261;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <h1>MCP Server</h1>
        <p class="subtitle">Codebase Knowledge Graph &amp; Analysis</p>
        
        <div class="stat-grid">
            <div class="stat-card">
                <div class="stat-value">20</div>
                <div class="stat-label">Source Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">12</div>
                <div class="stat-label">Test Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">0</div>
                <div class="stat-label">Orphan Files</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">95%+</div>
                <div class="stat-label">Test Coverage</div>
            </div>
        </div>
        
        <h2>Health Status</h2>
        <div>
            <span class="badge badge-success">No Orphans</span>
            <span class="badge badge-success">Full Test Coverage</span>
            <span class="badge badge-warning">Version Mismatch</span>
            <span class="badge badge-info">Missing Dependency</span>
        </div>
        
        <h2>Findings &amp; Recommendations</h2>
        
        <div class="finding">
            <div class="finding-title">Version Mismatch Detected</div>
            <div class="finding-desc">
                <code>lifecycle.py:13</code> defines <code>MCP_PROTOCOL_VERSION = "2024-11-05"</code> 
                but documentation and AGENT_PROMPT.md reference <code>"2025-11-25"</code>.
            </div>
            <div class="finding-action">
                Action: Update lifecycle.py to use "2025-11-25" for consistency.
            </div>
        </div>
        
        <div class="finding">
            <div class="finding-title">Missing Dependency: httpx</div>
            <div class="finding-desc">
                <code>websearch.py</code> imports <code>httpx</code> for HTTP requests, 
                but it's not listed in <code>pyproject.toml</code> dependencies.
            </div>
            <div class="finding-action">
                Action: Add <code>httpx>=0.27</code> to project dependencies.
            </div>
        </div>
        
        <div class="finding">
            <div class="finding-title">Loader Not Used</div>
            <div class="finding-desc">
                <code>PluginLoader</code> in <code>loader.py</code> is implemented but not used in 
                <code>main.py</code>. Plugins are registered manually instead.
            </div>
            <div class="finding-action">
                Action: Consider using PluginLoader for auto-discovery or document manual registration as intended pattern.
            </div>
        </div>
        
        <h2>Architecture Layers</h2>
        
        <h3>Protocol Layer</h3>
        <ul class="file-list">
            <li><span class="file-icon">&#128196;</span> jsonrpc.py - JSON-RPC 2.0 parsing</li>
            <li><span class="file-icon">&#128196;</span> lifecycle.py - MCP state machine</li>
            <li><span class="file-icon">&#128196;</span> tools.py - Tool handlers</li>
            <li><span class="file-icon">&#128196;</span> transport.py - STDIO I/O</li>
        </ul>
        
        <h3>Plugin Layer</h3>
        <ul class="file-list">
            <li><span class="file-icon">&#128196;</span> base.py - Abstract base class</li>
            <li><span class="file-icon">&#128196;</span> dispatcher.py - Tool routing</li>
            <li><span class="file-icon">&#128196;</span> loader.py - Plugin discovery</li>
            <li><span class="file-icon">&#128196;</span> websearch.py - DuckDuckGo search</li>
        </ul>
        
        <h3>Security Layer</h3>
        <ul class="file-list">
            <li><span class="file-icon">&#128196;</span> policy.py - YAML config loader</li>
            <li><span class="file-icon">&#128196;</span> firewall.py - Network ACL</li>
            <li><span class="file-icon">&#128196;</span> validator.py - Input sanitization</li>
            <li><span class="file-icon">&#128196;</span> engine.py - Security coordinator</li>
            <li><span class="file-icon">&#128196;</span> audit.py - Audit logging</li>
        </ul>
        
        <h2>Version Summary</h2>
        <ul class="file-list">
            <li><span class="file-icon">&#128640;</span> App Version: 1.0.0</li>
            <li><span class="file-icon">&#128268;</span> MCP Protocol: 2024-11-05 (code)</li>
            <li><span class="file-icon">&#128203;</span> Policy Config: 1.0</li>
            <li><span class="file-icon">&#128279;</span> Python: >=3.11</li>
        </ul>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #fff9c4;"></div>
                Entry Point
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e1f5fe;"></div>
                Core Server
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #e8f5e9;"></div>
                Protocol
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fff3e0;"></div>
                Plugins
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #fce4ec;"></div>
                Security
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f3e5f5;"></div>
                Config
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #eceff1;"></div>
                Tests
            </div>
        </div>
    </aside>
    
    <main class="main">
        <div class="graph-container">
            <div class="mermaid">
%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e1f5fe', 'primaryTextColor': '#01579b', 'primaryBorderColor': '#0288d1', 'lineColor': '#546e7a', 'secondaryColor': '#fff3e0', 'tertiaryColor': '#e8f5e9'}}}%%

flowchart TB
    %% Define all nodes first with safe IDs

    %% Entry Points
    main_py["main.py<br/>Entry Point"]

    %% Core Server
    server_py["server.py<br/>MCPServer"]

    %% Protocol Layer
    subgraph protocol["Protocol Layer"]
        direction TB
        jsonrpc_py["jsonrpc.py<br/>JSON-RPC Parser"]
        lifecycle_py["lifecycle.py<br/>LifecycleManager"]
        tools_py["tools.py<br/>ToolsHandler"]
        transport_py["transport.py<br/>StdioTransport"]
        protocol_init["__init__.py<br/>Protocol Exports"]
    end

    %% Plugins Layer
    subgraph plugins["Plugins Layer"]
        direction TB
        base_py["base.py<br/>PluginBase"]
        dispatcher_py["dispatcher.py<br/>ToolDispatcher"]
        loader_py["loader.py<br/>PluginLoader"]
        websearch_py["websearch.py<br/>WebSearchPlugin"]
        plugins_init["__init__.py<br/>Plugin Exports"]
    end

    %% Security Layer
    subgraph security["Security Layer"]
        direction TB
        policy_py["policy.py<br/>SecurityPolicy"]
        firewall_py["firewall.py<br/>NetworkFirewall"]
        validator_py["validator.py<br/>InputValidator"]
        engine_py["engine.py<br/>SecurityEngine"]
        audit_py["audit.py<br/>AuditLogger"]
        security_init["__init__.py<br/>Security Exports"]
    end

    %% Config
    subgraph config["Configuration"]
        policy_yaml["policy.yaml<br/>Security Config"]
    end

    %% Relationships - Entry Point
    main_py --> server_py
    main_py --> transport_py
    main_py --> websearch_py

    %% Relationships - Server Core
    server_py --> jsonrpc_py
    server_py --> lifecycle_py
    server_py --> tools_py
    server_py --> dispatcher_py
    server_py --> policy_py
    server_py --> engine_py

    %% Relationships - Protocol Internal
    tools_py --> base_py
    tools_py --> dispatcher_py
    protocol_init --> jsonrpc_py
    protocol_init --> lifecycle_py
    protocol_init --> tools_py
    protocol_init --> transport_py

    %% Relationships - Plugin Internal
    dispatcher_py --> base_py
    loader_py --> base_py
    websearch_py --> base_py
    plugins_init --> base_py
    plugins_init --> dispatcher_py
    plugins_init --> loader_py

    %% Relationships - Security Internal
    firewall_py --> policy_py
    validator_py --> policy_py
    engine_py --> firewall_py
    engine_py --> validator_py
    engine_py --> policy_py
    engine_py --> audit_py
    security_init --> policy_py
    security_init --> firewall_py
    security_init --> validator_py
    security_init --> engine_py
    security_init --> audit_py

    %% Relationships - Config
    policy_py -.-> policy_yaml

    %% Styling
    classDef entrypoint fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    classDef core fill:#e1f5fe,stroke:#0288d1,stroke-width:2px
    classDef protocol fill:#e8f5e9,stroke:#388e3c,stroke-width:1px
    classDef plugin fill:#fff3e0,stroke:#f57c00,stroke-width:1px
    classDef security fill:#fce4ec,stroke:#c2185b,stroke-width:1px
    classDef config fill:#f3e5f5,stroke:#7b1fa2,stroke-width:1px

    class main_py entrypoint
    class server_py core
    class jsonrpc_py,lifecycle_py,tools_py,transport_py,protocol_init protocol
    class base_py,dispatcher_py,loader_py,websearch_py,plugins_init plugin
    class policy_py,firewall_py,validator_py,engine_py,audit_py,security_init security
    class policy_yaml config
            </div>
        </div>
    </main>
    
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            }
        });
    </script>
</body>
</html>
