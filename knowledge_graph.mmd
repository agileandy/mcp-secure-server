%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#e1f5fe', 'primaryTextColor': '#01579b', 'primaryBorderColor': '#0288d1', 'lineColor': '#546e7a', 'secondaryColor': '#fff3e0', 'tertiaryColor': '#e8f5e9'}}}%%

flowchart TB
    %% Define all nodes first with safe IDs

    %% Entry Points
    main_py["main.py<br/>Entry Point"]

    %% Core Server
    server_py["server.py<br/>MCPServer"]

    %% Protocol Layer
    subgraph protocol["Protocol Layer"]
        direction TB
        jsonrpc_py["jsonrpc.py<br/>JSON-RPC Parser"]
        lifecycle_py["lifecycle.py<br/>LifecycleManager"]
        tools_py["tools.py<br/>ToolsHandler"]
        transport_py["transport.py<br/>StdioTransport"]
        protocol_init["__init__.py<br/>Protocol Exports"]
    end

    %% Plugins Layer
    subgraph plugins["Plugins Layer"]
        direction TB
        base_py["base.py<br/>PluginBase"]
        dispatcher_py["dispatcher.py<br/>ToolDispatcher"]
        loader_py["loader.py<br/>PluginLoader"]
        websearch_py["websearch.py<br/>WebSearchPlugin"]
        plugins_init["__init__.py<br/>Plugin Exports"]
    end

    %% Security Layer
    subgraph security["Security Layer"]
        direction TB
        policy_py["policy.py<br/>SecurityPolicy"]
        firewall_py["firewall.py<br/>NetworkFirewall"]
        validator_py["validator.py<br/>InputValidator"]
        engine_py["engine.py<br/>SecurityEngine"]
        audit_py["audit.py<br/>AuditLogger"]
        security_init["__init__.py<br/>Security Exports"]
    end

    %% Config
    subgraph config["Configuration"]
        policy_yaml["policy.yaml<br/>Security Config"]
    end

    %% Tests
    subgraph tests["Test Suite"]
        direction TB
        test_server["test_server.py"]
        test_jsonrpc["test_jsonrpc.py"]
        test_lifecycle["test_lifecycle.py"]
        test_tools["test_tools.py"]
        test_plugins["test_plugins.py"]
        test_policy["test_policy.py"]
        test_firewall["test_firewall.py"]
        test_validator["test_validator.py"]
        test_engine["test_engine.py"]
        test_audit["test_audit.py"]
        test_websearch["test_websearch.py"]
        test_integration["test_integration.py"]
    end

    %% Documentation
    subgraph docs["Documentation"]
        readme_md["README.md"]
        protocol_md["PROTOCOL.md"]
        security_md["SECURITY_POLICY.md"]
        plugin_md["PLUGIN_DEVELOPMENT.md"]
        agent_prompt["AGENT_PROMPT.md"]
    end

    %% Relationships - Entry Point
    main_py --> server_py
    main_py --> transport_py
    main_py --> websearch_py

    %% Relationships - Server Core
    server_py --> jsonrpc_py
    server_py --> lifecycle_py
    server_py --> tools_py
    server_py --> dispatcher_py
    server_py --> policy_py
    server_py --> engine_py

    %% Relationships - Protocol Internal
    tools_py --> base_py
    tools_py --> dispatcher_py
    protocol_init --> jsonrpc_py
    protocol_init --> lifecycle_py
    protocol_init --> tools_py
    protocol_init --> transport_py

    %% Relationships - Plugin Internal
    dispatcher_py --> base_py
    loader_py --> base_py
    websearch_py --> base_py
    plugins_init --> base_py
    plugins_init --> dispatcher_py
    plugins_init --> loader_py

    %% Relationships - Security Internal
    firewall_py --> policy_py
    validator_py --> policy_py
    engine_py --> firewall_py
    engine_py --> validator_py
    engine_py --> policy_py
    engine_py --> audit_py
    security_init --> policy_py
    security_init --> firewall_py
    security_init --> validator_py
    security_init --> engine_py
    security_init --> audit_py

    %% Relationships - Config
    policy_py -.-> policy_yaml

    %% Relationships - Tests
    test_server --> server_py
    test_jsonrpc --> jsonrpc_py
    test_lifecycle --> lifecycle_py
    test_tools --> tools_py
    test_plugins --> base_py
    test_plugins --> dispatcher_py
    test_plugins --> loader_py
    test_policy --> policy_py
    test_firewall --> firewall_py
    test_validator --> validator_py
    test_engine --> engine_py
    test_audit --> audit_py
    test_websearch --> websearch_py
    test_integration --> server_py

    %% Styling
    classDef entrypoint fill:#fff9c4,stroke:#f9a825,stroke-width:2px
    classDef core fill:#e1f5fe,stroke:#0288d1,stroke-width:2px
    classDef protocol fill:#e8f5e9,stroke:#388e3c,stroke-width:1px
    classDef plugin fill:#fff3e0,stroke:#f57c00,stroke-width:1px
    classDef security fill:#fce4ec,stroke:#c2185b,stroke-width:1px
    classDef config fill:#f3e5f5,stroke:#7b1fa2,stroke-width:1px
    classDef test fill:#eceff1,stroke:#546e7a,stroke-width:1px
    classDef docs fill:#e0e0e0,stroke:#757575,stroke-width:1px

    class main_py entrypoint
    class server_py core
    class jsonrpc_py,lifecycle_py,tools_py,transport_py,protocol_init protocol
    class base_py,dispatcher_py,loader_py,websearch_py,plugins_init plugin
    class policy_py,firewall_py,validator_py,engine_py,audit_py,security_init security
    class policy_yaml config
    class test_server,test_jsonrpc,test_lifecycle,test_tools,test_plugins,test_policy,test_firewall,test_validator,test_engine,test_audit,test_websearch,test_integration test
    class readme_md,protocol_md,security_md,plugin_md,agent_prompt docs
